<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEON DODGE: RESOLVE</title>
  <meta property="og:type" content="website" />
  <meta property="og:title" content="NEON DODGE: RESOLVE" />
  <meta property="og:description" content="네온 스타일 아케이드 회피 게임" />
  <meta property="og:image" content="https://mini-game-f5e.pages.dev/assets/neon-preview.png" />
  <meta property="og:url" content="https://mini-game-f5e.pages.dev/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="NEON DODGE: RESOLVE" />
  <meta name="twitter:description" content="네온 스타일 아케이드 회피 게임" />
  <meta name="twitter:image" content="https://mini-game-f5e.pages.dev/assets/neon-preview.png" />
  <style>
    :root{
      --bg:#070b16;
      --bg2:#0d1530;
      --line:rgba(120,170,255,.22);
      --text:#dfe9ff;
      --muted:#9fb4df;
      --cyan:#43e7ff;
      --purple:#9a6cff;
      --red:#ff5b84;
      --ok:#52ffa8;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      color:var(--text);
      font-family:Inter, Pretendard, 'Noto Sans KR', system-ui, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, #1f2b61 0%, transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, #25184b 0%, transparent 58%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      display:grid;
      place-items:center;
      overflow:hidden;
    }

    .noise{position:fixed;inset:0;pointer-events:none;opacity:.06;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity=".6"/></svg>');}

    .app{
      width:min(98vw,1220px);
      display:grid;
      grid-template-columns: minmax(0,1fr) 280px;
      gap:12px;
      align-items:stretch;
    }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(16,25,55,.62), rgba(9,14,33,.74));
      backdrop-filter: blur(8px);
      border-radius:18px;
      box-shadow:
        0 12px 40px rgba(0,0,0,.35),
        inset 0 0 0 1px rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
    }

    .arena{padding:8px}
    canvas{
      width:100%; height:auto; display:block;
      border-radius:12px;
      border:1px solid rgba(130,180,255,.25);
      background:linear-gradient(180deg,#0a1022,#0a132b 58%, #0a1022);
      box-shadow:inset 0 0 50px rgba(67,231,255,.05), 0 0 22px rgba(67,231,255,.15);
      touch-action:none;
    }

    .hud{padding:16px}
    .title{font-size:22px;font-weight:800;letter-spacing:.3px;line-height:1.2}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    .stats{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pill{padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    .pill b{display:block;font-size:20px;margin-top:2px}
    .pill span{font-size:12px;color:var(--muted)}

    .controls{margin-top:14px;display:grid;gap:8px}
    .btn{
      border:1px solid transparent;
      border-radius:12px;
      padding:11px 12px;
      font-weight:700;
      cursor:pointer;
      transition:.15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.main{
      color:#031525;
      background:linear-gradient(135deg,var(--cyan),#8cf4ff);
      box-shadow:0 8px 24px rgba(67,231,255,.35);
    }
    .btn.ghost{
      color:var(--text);
      border-color:var(--line);
      background:rgba(255,255,255,.03);
    }
    .shield-chip{
      border-color: rgba(67,231,255,.45) !important;
      background: linear-gradient(135deg, rgba(67,231,255,.16), rgba(154,108,255,.14)) !important;
      box-shadow: 0 0 0 1px rgba(67,231,255,.12) inset, 0 6px 16px rgba(67,231,255,.14);
      font-weight: 800;
    }
    .shield-chip:hover{
      background: linear-gradient(135deg, rgba(67,231,255,.22), rgba(154,108,255,.2)) !important;
    }

    .kbd{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;color:var(--muted);font-size:12px}
    .kbd i{font-style:normal;padding:3px 7px;border-radius:7px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#e7eeff}

    .touch-controls{display:none;gap:10px;margin-top:8px}
    .touch-btn{
      flex:1;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 0;
      font-weight:800;
      font-size:16px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    .touch-btn:active{background:rgba(67,231,255,.18)}

    .overlay{
      position:absolute; inset:12px;
      display:grid; place-items:center;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(2,7,20,.42), rgba(2,7,20,.74));
      text-align:center;
      padding:20px;
    }
    .overlay.hidden{display:none}
    .overlay h2{margin:0;font-size:40px;letter-spacing:1px}
    .overlay p{margin:8px 0 14px;color:var(--muted)}

    .glow{position:absolute;pointer-events:none;border-radius:999px;filter:blur(30px);opacity:.28}
    .g1{width:220px;height:220px;background:var(--cyan);left:-60px;top:-60px}
    .g2{width:180px;height:180px;background:var(--purple);right:-50px;bottom:-50px}

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
    }
    .mobile-nav{display:none}
    @media (max-width:760px){
      body{overflow:auto;align-items:start;padding:6px 0 68px}
      .app{width:100vw;gap:8px}
      .arena{padding:4px}
      .hud{padding:10px}
      .title{font-size:18px}
      .pill b{font-size:18px}
      .touch-controls{display:flex}
      .stats{gap:8px;margin-top:10px}
      .touch-btn{padding:14px 0;font-size:18px}

      /* 시작 전 랭킹 크게 노출 */
      #rankingCard.ranking-prestart{padding:14px;border-width:2px;border-color:rgba(67,231,255,.5);box-shadow:0 0 0 2px rgba(67,231,255,.12),0 12px 24px rgba(0,0,0,.25)}
      #rankingCard.ranking-prestart ol{font-size:15px;gap:8px}
      #rankingCard.ranking-prestart li{line-height:1.35}

      .mobile-nav{position:fixed;left:10px;right:10px;bottom:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;border-radius:14px;border:1px solid var(--line);background:rgba(9,14,33,.9);backdrop-filter:blur(8px);z-index:99;transition:opacity .22s ease, transform .22s ease}
      .mobile-nav.hidden{opacity:0;transform:translateY(14px);pointer-events:none}
      .mobile-nav button{border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--text);font-weight:800;border-radius:10px;padding:11px 0}
      .mobile-nav button.active{background:linear-gradient(135deg,var(--cyan),#8cf4ff);color:#031525;border-color:transparent}

      /* 하단 탭에 카드가 가리지 않도록 여유 공간 */
      #rankingCard,#bugCard{margin-bottom:78px}
      #bugList{max-height:42vh !important}
      #bugAdminBtn{padding:6px 9px !important;font-size:11px !important}
    }
    @media (min-width:761px){
      #bugCard{max-height:58vh;overflow:auto}
      #bugList{max-height:38vh !important}
    }
  </style>
</head>
<body>
  <div class="noise"></div>

  <div class="app">
    <section class="card arena">
      <span class="glow g1"></span><span class="glow g2"></span>
      <canvas id="game" width="720" height="680"></canvas>
      <div class="overlay" id="overlay">
        <div>
          <h2 id="ovTitle">NEON DODGE</h2>
          <p id="ovDesc">좌우 이동으로 장애물을 피하세요</p>
          <button class="btn main" id="startBtn">게임 시작</button>
        </div>
      </div>
    </section>

    <aside class="card hud">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div>
          <div class="title">NEON DODGE: <span style="color:var(--cyan)">RESOLVE</span></div>
          <div class="sub">made by 김예준 (with openclaw)</div>
        </div>
        <button class="btn ghost shield-chip" id="adShield" style="padding:8px 10px;font-size:12px;white-space:nowrap">보호막 받기</button>
      </div>

      <div class="touch-controls">
        <button class="touch-btn" id="touchLeft">◀ 왼쪽</button>
        <button class="touch-btn" id="touchRight">오른쪽 ▶</button>
      </div>

      <div class="stats">
        <div class="pill"><span>점수</span><b id="score">0</b></div>
        <div class="pill"><span>최고점</span><b id="best">0</b></div>
        <div class="pill"><span>레벨</span><b id="level">1</b></div>
        <div class="pill"><span>보호막</span><b id="shield">0</b></div>
        <div class="pill"><span>상태</span><b id="state">대기</b></div>
      </div>

      <div class="controls">
        <button class="btn main" id="restart">다시 시작</button>
        <button class="btn ghost" id="pause">일시정지 / 재개 (Space)</button>
        <button class="btn ghost" id="sound">사운드: ON</button>
      </div>

      <div class="card" id="rankingCard" style="margin-top:12px;padding:10px;border-radius:12px">
        <div style="font-weight:800;font-size:14px;margin-bottom:8px">랭킹 TOP 10</div>
        <ol id="ranking" style="margin:0;padding-left:20px;display:grid;gap:4px;font-size:13px;color:#dfe9ff">
          <li style="color:#9fb4df">불러오는 중...</li>
        </ol>
        <div id="rankingTies" style="display:none;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(140,180,255,.25);font-size:12px;color:#cfe0ff;white-space:nowrap;overflow-x:auto"></div>
      </div>

      <div class="card" id="bugCard" style="margin-top:10px;padding:10px;border-radius:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
          <div style="font-weight:800;font-size:14px">버그 제보</div>
          <button id="bugAdminBtn" class="btn ghost" style="padding:4px 8px;font-size:11px">관리자</button>
        </div>
        <div style="display:grid;gap:6px">
          <input id="bugName" maxlength="20" placeholder="이름(선택)" style="padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#dfe9ff" />
          <textarea id="bugText" maxlength="300" placeholder="버그 내용" style="min-height:68px;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#dfe9ff;resize:vertical"></textarea>
          <button class="btn ghost" id="bugSubmit" style="padding:8px 10px">제보 보내기</button>
        </div>
        <div id="bugMsg" style="font-size:12px;color:var(--muted);margin-top:6px"></div>

        <div id="bugAdminPanel" style="display:none;margin-top:8px;border:1px solid rgba(130,170,255,.3);border-radius:10px;padding:8px;background:rgba(90,130,255,.06)">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div style="font-weight:700;font-size:12px;color:#cfe0ff">최근 제보(관리자)</div>
            <button id="bugAdminClose" class="btn ghost" style="padding:3px 8px;font-size:11px">닫기</button>
          </div>
          <ul id="bugList" style="margin:6px 0 0;padding-left:18px;display:grid;gap:4px;font-size:12px;color:#c8d8ff;max-height:260px;overflow:auto">
            <li style="color:#9fb4df">불러오는 중...</li>
          </ul>
        </div>
      </div>

      <div class="kbd">
        <i>←</i><i>→</i> 이동
        <i>Space</i> 일시정지
      </div>
    </aside>
  </div>

  <div class="mobile-nav" id="mobileNav">
    <button id="navGame" class="active">게임</button>
    <button id="navRank">랭킹</button>
    <button id="navBug">버그</button>
  </div>

  <div id="rankNameModal" style="display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.55);place-items:center">
    <div style="width:min(92vw,360px);background:#0c1328;border:1px solid rgba(120,170,255,.35);border-radius:14px;padding:14px">
      <div style="font-weight:800;font-size:16px;margin-bottom:8px">랭킹 이름</div>
      <input id="rankNameInput" maxlength="20" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" enterkeyhint="done" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(120,170,255,.35);background:#0a1022;color:#eaf1ff" />
      <div id="rankNameHint" style="margin-top:6px;font-size:12px;color:#9fb4df">랭킹 등록하려면 닉네임을 입력해야 해.</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="rankNameSkip" class="btn ghost" style="padding:8px 12px">등록 안함</button>
        <button id="rankNameSave" class="btn main" style="padding:8px 12px">등록</button>
      </div>
    </div>
  </div>

  <div id="bugAdminModal" style="display:none;position:fixed;inset:0;z-index:130;background:rgba(0,0,0,.58);place-items:center">
    <div style="width:min(92vw,360px);background:#0c1328;border:1px solid rgba(120,170,255,.35);border-radius:14px;padding:14px">
      <div style="font-weight:800;font-size:16px;margin-bottom:8px">관리자 인증</div>
      <input id="bugAdminInput" type="password" maxlength="32" placeholder="비밀번호" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(120,170,255,.35);background:#0a1022;color:#eaf1ff" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="bugAdminCancel" class="btn ghost" style="padding:8px 12px">취소</button>
        <button id="bugAdminConfirm" class="btn main" style="padding:8px 12px">확인</button>
      </div>
    </div>
  </div>

  <div id="adModal" style="display:none;position:fixed;inset:0;z-index:131;background:rgba(0,0,0,.62);place-items:center">
    <div style="width:min(94vw,420px);background:#0c1328;border:1px solid rgba(120,170,255,.35);border-radius:14px;padding:14px">
      <div style="display:flex;align-items:center;gap:8px">
        <img src="./assets/ddsm-logo.jpg" alt="학교 로고" style="width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid rgba(140,190,255,.35)" />
        <div style="font-weight:900;font-size:16px;color:#7ce9ff">[학교 홍보]</div>
      </div>
      <div style="font-weight:800;margin-top:6px">대덕소프트웨어마이스터고등학교</div>
      <div style="font-size:13px;color:#cfe0ff;line-height:1.5;margin-top:8px">
        소프트웨어/AI/보안에 강한 마이스터고!<br/>
        프로젝트 중심 수업, 실전 개발 경험, 해커톤/공모전 활동까지.
      </div>
      <div style="margin-top:10px;padding:10px;border-radius:10px;background:rgba(80,130,255,.12);font-size:12px;color:#bfe4ff">
        홍보를 끝까지 보면 게임에서 사용할 보호막 1개를 받을 수 있어.
      </div>
      <div id="adCountdown" style="margin-top:10px;font-weight:800">남은 시간: 5초</div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button id="adClose" class="btn ghost" style="padding:8px 12px" disabled>닫기</button>
      </div>
    </div>
  </div>

  <script>
    const cv = document.getElementById('game');
    const ctx = cv.getContext('2d');

    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const levelEl = document.getElementById('level');
    const shieldEl = document.getElementById('shield');
    const stateEl = document.getElementById('state');
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ovTitle');
    const ovDesc = document.getElementById('ovDesc');
    const startBtn = document.getElementById('startBtn');

    const restartBtn = document.getElementById('restart');
    const pauseBtn = document.getElementById('pause');
    const soundBtn = document.getElementById('sound');
    const adShieldBtn = document.getElementById('adShield');
    const touchLeftBtn = document.getElementById('touchLeft');
    const touchRightBtn = document.getElementById('touchRight');
    const rankingEl = document.getElementById('ranking');
    const rankingCard = document.getElementById('rankingCard');
    const rankingTies = document.getElementById('rankingTies');
    const bugCard = document.getElementById('bugCard');
    const bugName = document.getElementById('bugName');
    const bugText = document.getElementById('bugText');
    const bugSubmit = document.getElementById('bugSubmit');
    const bugMsg = document.getElementById('bugMsg');
    const bugList = document.getElementById('bugList');
    const bugAdminBtn = document.getElementById('bugAdminBtn');
    const bugAdminPanel = document.getElementById('bugAdminPanel');
    const bugAdminClose = document.getElementById('bugAdminClose');
    const bugAdminModal = document.getElementById('bugAdminModal');
    const bugAdminInput = document.getElementById('bugAdminInput');
    const bugAdminCancel = document.getElementById('bugAdminCancel');
    const bugAdminConfirm = document.getElementById('bugAdminConfirm');
    const adModal = document.getElementById('adModal');
    const adCountdown = document.getElementById('adCountdown');
    const adClose = document.getElementById('adClose');
    const navGame = document.getElementById('navGame');
    const navRank = document.getElementById('navRank');
    const navBug = document.getElementById('navBug');
    const mobileNav = document.getElementById('mobileNav');
    const rankNameModal = document.getElementById('rankNameModal');
    const rankNameInput = document.getElementById('rankNameInput');
    const rankNameSave = document.getElementById('rankNameSave');
    const rankNameSkip = document.getElementById('rankNameSkip');
    const rankNameHint = document.getElementById('rankNameHint');
    let navRevealTimer = null;
    let bugAdminKey = sessionStorage.getItem('bug_admin_key') || '';
    let runPingTimer = null;

    const W = cv.width, H = cv.height;
    const MAINTENANCE_MODE = false;

    const state = {
      started:false,
      running:false,
      paused:false,
      left:false,
      right:false,
      tick:0,
      score:0,
      best:+localStorage.getItem('neon_dodge_best')||0,
      level:1,
      speedMul:1,
      spawnRate:26,
      rocks:[],
      particles:[],
      soundOn: (localStorage.getItem('neon_dodge_sound') ?? 'on') === 'on',
      rankNameOpen:false,
      runToken:'',
      shields:0,
      adWatching:false,
      adCooldownUntil:0
    };

    const player = { x:W/2-22, y:H-78, w:44, h:44, speed:7 };

    let audioCtx = null;
    let bgmGain = null;
    let bgmTimer = null;
    let bgmStep = 0;
    const bgmNotes = [220, 277.18, 329.63, 392.0, 329.63, 277.18, 246.94, 293.66];

    function ensureAudio(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        if(AC) audioCtx = new AC();
      }
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      if(audioCtx && !bgmGain){
        bgmGain = audioCtx.createGain();
        bgmGain.gain.value = 0.0001;
        bgmGain.connect(audioCtx.destination);
      }
    }

    function beep({freq=440,duration=0.08,type='sine',gain=0.03,slideTo=null}={}){
      if(!state.soundOn) return;
      ensureAudio();
      if(!audioCtx) return;
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq,t);
      if(slideTo) o.frequency.exponentialRampToValueAtTime(slideTo, t+duration);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(gain,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+duration);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t+duration+0.02);
    }

    function sfxStart(){ beep({freq:520,duration:.06,type:'triangle',gain:.04}); setTimeout(()=>beep({freq:760,duration:.08,type:'triangle',gain:.04}),55); }
    function sfxScore(){ beep({freq:680,duration:.05,type:'square',gain:.03,slideTo:820}); }
    function sfxHit(){ beep({freq:220,duration:.16,type:'sawtooth',gain:.05,slideTo:120}); setTimeout(()=>beep({freq:140,duration:.12,type:'square',gain:.04}),60); }
    function sfxPause(){ beep({freq:420,duration:.07,type:'triangle',gain:.03}); }

    function bgmTick(){
      if(!state.soundOn || !state.running || state.paused) return;
      ensureAudio();
      if(!audioCtx || !bgmGain) return;
      const t = audioCtx.currentTime;
      const base = bgmNotes[bgmStep % bgmNotes.length];
      const o1 = audioCtx.createOscillator();
      const o2 = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o1.type = 'triangle'; o2.type = 'sine';
      o1.frequency.setValueAtTime(base, t);
      o2.frequency.setValueAtTime(base*2, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.06, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.32);
      o1.connect(g); o2.connect(g); g.connect(bgmGain);
      o1.start(t); o2.start(t); o1.stop(t+0.34); o2.stop(t+0.34);
      bgmStep++;
    }

    function startBgm(){
      if(bgmTimer) return;
      ensureAudio();
      if(bgmGain){
        const t = audioCtx.currentTime;
        bgmGain.gain.cancelScheduledValues(t);
        bgmGain.gain.setValueAtTime(Math.max(0.0001,bgmGain.gain.value), t);
        bgmGain.gain.exponentialRampToValueAtTime(0.25, t+0.25);
      }
      bgmTimer = setInterval(bgmTick, 260);
    }

    function stopBgm(){
      if(bgmTimer){ clearInterval(bgmTimer); bgmTimer = null; }
      if(audioCtx && bgmGain){
        const t = audioCtx.currentTime;
        bgmGain.gain.cancelScheduledValues(t);
        bgmGain.gain.setValueAtTime(Math.max(0.0001,bgmGain.gain.value), t);
        bgmGain.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
      }
    }

    function updateSoundBtn(){ if(soundBtn) soundBtn.textContent = `사운드: ${state.soundOn ? 'ON' : 'OFF'}`; }

    function rankName(){
      return (localStorage.getItem('neon_dodge_rank_name') || '').trim();
    }

    function adminHeaders(extra={}){
      const h = { ...extra };
      if(bugAdminKey) h['x-bug-admin-key'] = bugAdminKey;
      return h;
    }

    function renderRanking(rows=[]){
      if(!rankingEl) return;
      if(!rows.length){
        rankingEl.innerHTML = '<li style="color:#9fb4df">아직 기록 없음</li>';
        if(rankingTies){ rankingTies.style.display='none'; rankingTies.textContent=''; }
        return;
      }

      const top10 = rows.slice(0,10);
      rankingEl.innerHTML = top10.map(r => `<li>${r.name} · <b>${r.score}</b></li>`).join('');

      if(!rankingTies) return;
      const tenthScore = top10[9]?.score;
      const ties = rows.slice(10).filter(r => Number(r.score) === Number(tenthScore));
      if(ties.length){
        rankingTies.style.display = 'block';
        rankingTies.textContent = `동점자: ${ties.map(t => t.name).join(' · ')}`;
      } else {
        rankingTies.style.display = 'none';
        rankingTies.textContent = '';
      }
    }

    async function loadRanking(){
      try {
        const r = await fetch('/api/rank/top');
        const d = await r.json();
        renderRanking(d.top || []);
      } catch {
        // 네트워크 순간 오류에서는 기존 목록 유지
      }
    }

    function renderBugList(rows=[]){
      if(!bugList) return;
      if(!rows.length){
        bugList.innerHTML = '<li style="color:#9fb4df">아직 제보 없음</li>';
        return;
      }
      bugList.innerHTML = rows.slice(0,30).map(x => {
        const d = new Date(x.at);
        const when = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return `<li style="display:flex;gap:6px;align-items:flex-start;justify-content:space-between"><span><b>${x.name}</b> · ${x.text} <span style="color:#8fa8d8">(${when})</span></span><button class="btn ghost bug-del" data-token="${encodeURIComponent(x.token||'')}" style="padding:2px 7px;font-size:11px">삭제</button></li>`;
      }).join('');
    }

    function askBugAdminPassword(){
      return new Promise((resolve) => {
        if(!bugAdminModal) return resolve('');
        bugAdminModal.style.display = 'grid';
        bugAdminInput.value = '';
        setTimeout(() => bugAdminInput.focus(), 20);

        const cleanup = () => {
          bugAdminModal.style.display = 'none';
          bugAdminConfirm.onclick = null;
          bugAdminCancel.onclick = null;
          bugAdminInput.onkeydown = null;
          bugAdminModal.onclick = null;
        };

        bugAdminConfirm.onclick = () => {
          const v = String(bugAdminInput.value || '').trim();
          cleanup();
          resolve(v);
        };
        bugAdminCancel.onclick = () => { cleanup(); resolve(''); };
        bugAdminInput.onkeydown = (e) => {
          if(e.key === 'Enter') bugAdminConfirm.onclick();
          if(e.key === 'Escape') bugAdminCancel.onclick();
        };
        bugAdminModal.onclick = (e) => {
          if(e.target === bugAdminModal) bugAdminCancel.onclick();
        };
      });
    }

    async function ensureBugAdmin(){
      if(bugAdminKey) return true;
      const input = await askBugAdminPassword();
      if(!input) return false;
      bugAdminKey = input;
      sessionStorage.setItem('bug_admin_key', bugAdminKey);
      return true;
    }

    async function loadBugList(){
      if(!bugAdminKey) return;
      try{
        const r = await fetch('/api/bug/list', { headers: { 'x-bug-admin-key': bugAdminKey } });
        const d = await r.json();
        if(!r.ok){
          if(r.status === 401){
            bugAdminKey = '';
            sessionStorage.removeItem('bug_admin_key');
            if(bugMsg) bugMsg.textContent='관리자 비밀번호가 틀렸어.';
            if(bugAdminPanel) bugAdminPanel.style.display='none';
            if(bugAdminBtn) bugAdminBtn.textContent='관리자';
            return;
          }
          throw new Error(d.error || '불러오기 실패');
        }
        if(bugAdminBtn) bugAdminBtn.textContent='관리자 ON';
        renderBugList(d.bugs || []);
      }catch(e){
        if(bugMsg) bugMsg.textContent = e.message;
      }
    }

    async function deleteBug(token){
      if(!bugAdminKey) return;
      try{
        const r = await fetch('/api/bug/delete', {
          method:'POST',
          headers:{'content-type':'application/json','x-bug-admin-key': bugAdminKey},
          body: JSON.stringify({ token })
        });
        const d = await r.json();
        if(!r.ok) throw new Error(d.error || '삭제 실패');
        if(bugMsg) bugMsg.textContent='삭제 완료';
        loadBugList();
      }catch(e){
        if(bugMsg) bugMsg.textContent=e.message;
      }
    }

    async function submitBug(){
      const text = String(bugText?.value || '').trim();
      const name = String(bugName?.value || '').trim();
      if(!text){ if(bugMsg) bugMsg.textContent='버그 내용을 입력해줘.'; return; }
      if(bugSubmit) bugSubmit.disabled = true;
      try{
        const r = await fetch('/api/bug/submit', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ name, text })
        });
        const d = await r.json();
        if(!r.ok) throw new Error(d.error || '제보 실패');
        if(bugMsg) bugMsg.textContent='제보 완료';
        bugText.value = '';
        if(bugAdminKey) loadBugList();
      }catch(e){
        if(bugMsg) bugMsg.textContent=e.message;
      }finally{
        if(bugSubmit) bugSubmit.disabled = false;
      }
    }

    async function openBugAdminPanel(){
      const ok = await ensureBugAdmin();
      if(!ok) return;
      applyMaintenanceGate();
      if(bugAdminPanel) bugAdminPanel.style.display='block';
      if(bugAdminBtn) bugAdminBtn.textContent='관리자 ON';
      loadBugList();
      if(bugCard) bugCard.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function closeBugAdminPanel(){
      if(bugAdminPanel) bugAdminPanel.style.display='none';
      if(bugAdminBtn) bugAdminBtn.textContent='관리자';
    }

    function askRankName(defaultName){
      return new Promise((resolve) => {
        if(!rankNameModal) return resolve(defaultName || '');

        state.rankNameOpen = true;
        rankNameModal.style.display = 'grid';
        rankNameInput.value = defaultName || '';
        let isComposing = false;

        const validate = () => {
          const v = (rankNameInput.value || '').trim();
          const ok = v.length > 0;
          if(rankNameSave) rankNameSave.disabled = !ok;
          if(rankNameHint) rankNameHint.style.color = ok ? '#8fe7c2' : '#9fb4df';
          if(rankNameHint) rankNameHint.textContent = ok ? '좋아, 이 닉네임으로 등록할게.' : '랭킹 등록하려면 닉네임을 입력해야 해.';
        };

        setTimeout(() => {
          rankNameInput.focus();
          rankNameInput.select();
          validate();
        }, 30);

        const cleanup = () => {
          state.rankNameOpen = false;
          rankNameModal.style.display = 'none';
          rankNameSave.onclick = null;
          rankNameSkip.onclick = null;
          rankNameInput.onkeydown = null;
          rankNameInput.oninput = null;
          rankNameInput.oncompositionstart = null;
          rankNameInput.oncompositionend = null;
          rankNameModal.onclick = null;
        };

        rankNameSave.onclick = () => {
          const v = (rankNameInput.value || '').trim().slice(0,20);
          if(!v) return;
          cleanup();
          resolve(v);
        };
        rankNameSkip.onclick = () => {
          cleanup();
          resolve('');
        };

        rankNameInput.oninput = validate;
        rankNameInput.oncompositionstart = () => { isComposing = true; };
        rankNameInput.oncompositionend = () => { isComposing = false; validate(); };
        rankNameInput.onkeydown = (e) => {
          if(e.key === 'Enter' && !isComposing) rankNameSave.onclick();
          if(e.key === 'Escape') rankNameSkip.onclick();
        };

        rankNameModal.onclick = (e) => {
          if(e.target === rankNameModal) rankNameSkip.onclick();
        };
      });
    }

    async function sendRunPing(){
      if(!state.runToken || !state.running || state.paused) return;
      try{
        await fetch('/api/run/ping', {
          method:'POST',
          headers:adminHeaders({'content-type':'application/json'}),
          body: JSON.stringify({ runToken: state.runToken, score: state.score, x: Math.floor(player.x) })
        });
      }catch{}
    }

    function startRunPingLoop(){
      if(runPingTimer){ clearInterval(runPingTimer); runPingTimer = null; }
      sendRunPing();
      runPingTimer = setInterval(sendRunPing, 2000);
    }

    function stopRunPingLoop(){
      if(runPingTimer){ clearInterval(runPingTimer); runPingTimer = null; }
    }

    async function startRun(){
      try{
        const r = await fetch('/api/run/start', { method:'POST', headers: adminHeaders() });
        const d = await r.json();
        state.runToken = (r.ok && d.runToken) ? d.runToken : '';
        if(state.runToken) startRunPingLoop();
      }catch{
        state.runToken = '';
      }
    }

    async function submitRanking(score){
      if(score <= 0) return;
      if(!state.runToken) return; // 서버에서 발급한 런 토큰 없으면 제출 차단

      let name = await askRankName(rankName());
      if(!name){
        // 닉네임 미입력 시 랭킹 등록 안 함
        return;
      }
      localStorage.setItem('neon_dodge_rank_name', name);

      try {
        const r = await fetch('/api/rank/submit', {
          method:'POST',
          headers:adminHeaders({'content-type':'application/json'}),
          body: JSON.stringify({ name, score, runToken: state.runToken })
        });
        const d = await r.json();
        if(r.ok) state.runToken = '';
        renderRanking(d.top || []);
      } catch {}
    }

    function updateRankingVisibility(){
      if(!rankingCard) return;
      const isMobile = window.matchMedia('(max-width: 760px)').matches;

      if(isMobile){
        rankingCard.style.display = state.running ? 'none' : 'block';
        // 시작 전에는 크게 보여주기
        rankingCard.classList.toggle('ranking-prestart', !state.started && !state.running);
      } else {
        rankingCard.style.display = 'block';
        rankingCard.classList.remove('ranking-prestart');
      }
    }

    function setNav(tab){
      if(!navGame || !navRank || !navBug) return;
      navGame.classList.toggle('active', tab === 'game');
      navRank.classList.toggle('active', tab === 'rank');
      navBug.classList.toggle('active', tab === 'bug');

      const isMobile = window.matchMedia('(max-width: 760px)').matches;
      if(!mobileNav || !isMobile) return;

      if(navRevealTimer){ clearTimeout(navRevealTimer); navRevealTimer = null; }

      if(tab === 'rank' || tab === 'bug'){
        mobileNav.classList.add('hidden');
        navRevealTimer = setTimeout(() => {
          mobileNav.classList.remove('hidden');
        }, 1800);
      } else {
        mobileNav.classList.remove('hidden');
      }
    }

    function scrollToGame(){
      const arena = document.querySelector('.arena');
      if(arena) arena.scrollIntoView({ behavior:'smooth', block:'start' });
      setNav('game');
    }

    function scrollToRank(){
      if(state.running){
        setNav('game');
        return;
      }
      if(rankingCard) rankingCard.scrollIntoView({ behavior:'smooth', block:'start' });
      setNav('rank');
    }

    function scrollToBug(){
      if(bugCard) bugCard.scrollIntoView({ behavior:'smooth', block:'start' });
      setNav('bug');
    }

    function setOverlay(title, desc, show=true){
      ovTitle.textContent = title;
      ovDesc.textContent = desc;
      overlay.classList.toggle('hidden', !show);
    }

    function applyMaintenanceGate(){
      if(!MAINTENANCE_MODE) return;
      const isAdmin = !!bugAdminKey;
      if(!isAdmin){
        state.running = false;
        state.started = false;
        setOverlay('서버 점검중', '지금은 관리자만 테스트 가능해.', true);
        if(startBtn) startBtn.disabled = true;
        if(restartBtn) restartBtn.disabled = true;
      } else {
        if(startBtn) startBtn.disabled = false;
        if(restartBtn) restartBtn.disabled = false;
        if(!state.started && !state.running) setOverlay('NEON DODGE', '좌우 이동으로 장애물을 피하세요', true);
      }
    }

    function watchSchoolAdForShield(){
      if(state.adWatching) return;
      const now = Date.now();
      if(now < state.adCooldownUntil) return;

      // 광고 중 일시정지
      const wasRunning = state.running && !state.paused;
      if(wasRunning){
        state.paused = true;
        stopBgm();
      }

      state.adWatching = true;
      let sec = 5;
      if(adModal) adModal.style.display = 'grid';
      if(adClose) adClose.disabled = false;
      if(adCountdown) adCountdown.textContent = `남은 시간: ${sec}초`;
      refreshHUD();

      const t = setInterval(() => {
        sec -= 1;
        if(adCountdown) adCountdown.textContent = `남은 시간: ${Math.max(0,sec)}초`;
        if(sec <= 0){
          clearInterval(t);
          state.shields += 1;
          state.adWatching = false;
          state.adCooldownUntil = Date.now() + 45000;
          if(adCountdown) adCountdown.textContent = '시청 완료! 보호막 +1';
          refreshHUD();
        }
      }, 1000);

      if(adClose){
        adClose.onclick = () => {
          const completed = !state.adWatching;
          if(state.adWatching){
            clearInterval(t);
            state.adWatching = false;
            if(adCountdown) adCountdown.textContent = '시청 취소 (보상 없음)';
          }
          if(adModal) adModal.style.display = 'none';

          // 광고 전 플레이 중이었다면 재개
          if(wasRunning){
            state.paused = false;
            if(state.soundOn) startBgm();
            overlay.classList.add('hidden');
          }

          if(!completed) state.adCooldownUntil = 0;
          refreshHUD();
        };
      }
    }

    function refreshHUD(){
      scoreEl.textContent = state.score;
      bestEl.textContent = state.best;
      levelEl.textContent = state.level;
      if(shieldEl) shieldEl.textContent = state.shields;
      stateEl.textContent = !state.started ? '대기' : state.paused ? '일시정지' : state.running ? '플레이중' : '종료';
      if(adShieldBtn){
        const remain = Math.max(0, Math.ceil((state.adCooldownUntil - Date.now())/1000));
        adShieldBtn.disabled = state.adWatching || remain > 0;
        adShieldBtn.textContent = remain > 0 ? `보호막 대기 (${remain}s)` : '보호막 받기';
      }
      updateRankingVisibility();
    }

    function spawnRock(){
      const s = 22 + Math.random()*42;
      state.rocks.push({
        x: Math.random()*(W-s), y: -s,
        w: s, h: s,
        v: (2.2 + Math.random()*3.8) * state.speedMul,
        hue: 340 + Math.random()*30
      });
    }

    function burst(x,y,color='#43e7ff'){
      for(let i=0;i<24;i++){
        const a=Math.random()*Math.PI*2;
        const sp=1+Math.random()*4;
        state.particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:26+Math.random()*24,color});
      }
    }

    function overlap(a,b){
      return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
    }

    function resetGame(startNow=false){
      state.started = startNow;
      state.running = startNow;
      state.paused = false;
      state.runToken = '';
      stopRunPingLoop();
      if(startNow) startRun();
      if(startNow && state.soundOn) startBgm(); else stopBgm();
      state.tick = 0;
      state.score = 0;
      state.level = 1;
      state.speedMul = 1;
      state.spawnRate = 26;
      state.rocks.length = 0;
      state.particles.length = 0;
      player.x = W/2-player.w/2;
      refreshHUD();
      if(startNow){ setOverlay('READY', '행운을 빌어. 집중해.', true); setTimeout(()=>setOverlay('','',false), 700); }
      else setOverlay('NEON DODGE', '좌우 이동으로 장애물을 피하세요', true);
    }

    function gameOver(){
      state.running = false;
      state.paused = false;
      stopRunPingLoop();
      stopBgm();
      sfxHit();
      if(state.score > state.best){
        state.best = state.score;
        localStorage.setItem('neon_dodge_best', state.best);
      }
      refreshHUD();
      setOverlay('GAME OVER', `점수 ${state.score} · 최고 ${state.best}`, true);
      submitRanking(state.score);
    }

    function togglePause(){
      if(!state.running) return;
      state.paused = !state.paused;
      sfxPause();
      if(state.paused){
        stopBgm();
        setOverlay('PAUSED', 'Space로 재개', true);
      } else {
        if(state.soundOn) startBgm();
        overlay.classList.add('hidden');
      }
      refreshHUD();
    }

    function updateDifficulty(){
      const lv = 1 + Math.floor(state.score / 12);
      state.level = lv;
      state.speedMul = 1 + (lv-1)*0.12;
      state.spawnRate = Math.max(10, 26 - (lv-1));
    }

    function update(dt=1){
      if(!state.running || state.paused) return;
      state.tick += dt;

      if(state.left) player.x -= player.speed * dt;
      if(state.right) player.x += player.speed * dt;
      player.x = Math.max(0, Math.min(W-player.w, player.x));

      updateDifficulty();
      while(state.tick >= state.spawnRate){
        spawnRock();
        state.tick -= state.spawnRate;
      }

      for(let i=state.rocks.length-1;i>=0;i--){
        const r = state.rocks[i];
        r.y += r.v * dt;

        if(overlap(player,r)){
          if(state.shields > 0){
            state.shields--;
            burst(player.x+player.w/2, player.y+player.h/2, '#43e7ff');
            state.rocks.splice(i,1);
            refreshHUD();
            continue;
          }
          burst(player.x+player.w/2, player.y+player.h/2, '#ff5b84');
          gameOver();
          return;
        }

        if(r.y > H+60){
          state.rocks.splice(i,1);
          state.score++;
          if(state.score % 2 === 0) sfxScore();
          burst(r.x+r.w/2, H-6, '#52ffa8');
          refreshHUD();
        }
      }

      for(let i=state.particles.length-1;i>=0;i--){
        const p = state.particles[i];
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vy += 0.04 * dt;
        p.life -= dt;
        if(p.life<=0) state.particles.splice(i,1);
      }
    }

    function drawGrid(){
      ctx.save();
      ctx.strokeStyle = 'rgba(110,168,254,.12)';
      ctx.lineWidth = 1;
      const step = 34;
      const oy = (state.tick*0.7)%step;
      for(let y=-step;y<H+step;y+=step){
        ctx.beginPath(); ctx.moveTo(0,y+oy); ctx.lineTo(W,y+oy); ctx.stroke();
      }
      ctx.restore();
    }

    function drawPlayer(){
      ctx.save();
      const x=player.x,y=player.y,w=player.w,h=player.h;

      // 보호막 오라(활성 시만)
      if(state.shields > 0){
        const pulse = 0.55 + 0.45 * Math.sin(performance.now() / 220);
        ctx.strokeStyle = `rgba(67,231,255,${0.35 + pulse * 0.35})`;
        ctx.lineWidth = 3;
        ctx.shadowBlur = 18 + pulse * 10;
        ctx.shadowColor = 'rgba(67,231,255,.9)';
        roundRect(x-7, y-7, w+14, h+14, 14, false, true);
      }

      ctx.shadowBlur = 20;
      ctx.shadowColor = '#43e7ff';
      const g=ctx.createLinearGradient(x,y,x+w,y+h);
      g.addColorStop(0,'#8cf4ff'); g.addColorStop(1,'#3bc6ff');
      ctx.fillStyle = g;
      roundRect(x,y,w,h,10,true);
      ctx.fillStyle = 'rgba(3,18,35,.55)';
      roundRect(x+11,y+8,22,9,5,true);
      ctx.restore();
    }

    function drawRock(r){
      ctx.save();
      ctx.shadowBlur = 16;
      ctx.shadowColor = `hsla(${r.hue},95%,65%,.7)`;
      const g=ctx.createLinearGradient(r.x,r.y,r.x+r.w,r.y+r.h);
      g.addColorStop(0,`hsl(${r.hue} 95% 70%)`);
      g.addColorStop(1,`hsl(${r.hue-14} 78% 58%)`);
      ctx.fillStyle=g;
      roundRect(r.x,r.y,r.w,r.h,8,true);
      ctx.restore();
    }

    function drawParticles(){
      for(const p of state.particles){
        ctx.globalAlpha = Math.max(0,p.life/30);
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x,p.y,3,3);
      }
      ctx.globalAlpha = 1;
    }

    function render(){
      ctx.clearRect(0,0,W,H);

      const bg = ctx.createLinearGradient(0,0,0,H);
      bg.addColorStop(0,'#0a1227');
      bg.addColorStop(1,'#091125');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);

      drawGrid();
      drawPlayer();
      state.rocks.forEach(drawRock);
      drawParticles();

      ctx.fillStyle = 'rgba(220,235,255,.85)';
      ctx.font = '600 16px Inter, sans-serif';
      ctx.fillText(`SCORE ${state.score}`, 16, 28);
      ctx.fillText(`LEVEL ${state.level}`, 16, 50);
    }

    function roundRect(x,y,w,h,r,fill,stroke=false){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    let lastTs = 0;
    function loop(ts=0){
      const deltaMs = lastTs ? (ts - lastTs) : 16.67;
      lastTs = ts;
      const dt = Math.min(2.2, Math.max(0.6, deltaMs / 16.67));
      update(dt);
      render();
      requestAnimationFrame(loop);
    }

    function isTypingTarget(el){
      if(!el) return false;
      const tag = (el.tagName || '').toLowerCase();
      return tag === 'input' || tag === 'textarea' || el.isContentEditable;
    }

    addEventListener('keydown', (e)=>{
      if(state.rankNameOpen) return;
      if(isTypingTarget(e.target)) return;
      if(e.key==='ArrowLeft') state.left=true;
      if(e.key==='ArrowRight') state.right=true;
      if(e.code==='Space'){ e.preventDefault(); togglePause(); }
    });
    addEventListener('keyup', (e)=>{
      if(e.key==='ArrowLeft') state.left=false;
      if(e.key==='ArrowRight') state.right=false;
    });

    function bindTouch(btn, dir){
      if(!btn) return;
      const on = (e)=>{ e.preventDefault(); state[dir]=true; };
      const off = (e)=>{ e.preventDefault(); state[dir]=false; };
      btn.addEventListener('touchstart', on, {passive:false});
      btn.addEventListener('touchend', off, {passive:false});
      btn.addEventListener('touchcancel', off, {passive:false});
      btn.addEventListener('pointerdown', on);
      btn.addEventListener('pointerup', off);
      btn.addEventListener('pointerleave', off);
      btn.addEventListener('mousedown', on);
      btn.addEventListener('mouseup', off);
      btn.addEventListener('mouseleave', off);
    }

    bindTouch(touchLeftBtn, 'left');
    bindTouch(touchRightBtn, 'right');

    cv.addEventListener('touchstart', (e)=>{
      const t = e.touches[0];
      if(!t) return;
      const rect = cv.getBoundingClientRect();
      const x = t.clientX - rect.left;
      if(x < rect.width/2){ state.left = true; state.right = false; }
      else { state.right = true; state.left = false; }
      e.preventDefault();
    }, {passive:false});

    cv.addEventListener('touchmove', (e)=>{
      const t = e.touches[0];
      if(!t) return;
      const rect = cv.getBoundingClientRect();
      const x = t.clientX - rect.left;
      if(x < rect.width/2){ state.left = true; state.right = false; }
      else { state.right = true; state.left = false; }
      e.preventDefault();
    }, {passive:false});

    cv.addEventListener('touchend', ()=>{ state.left=false; state.right=false; }, {passive:false});

    startBtn.onclick = () => {
      if(MAINTENANCE_MODE && !bugAdminKey){ applyMaintenanceGate(); return; }
      ensureAudio(); sfxStart(); resetGame(true); overlay.classList.add('hidden');
    };
    restartBtn.onclick = () => {
      if(MAINTENANCE_MODE && !bugAdminKey){ applyMaintenanceGate(); return; }
      ensureAudio(); sfxStart(); resetGame(true); overlay.classList.add('hidden');
    };
    pauseBtn.onclick = togglePause;
    soundBtn.onclick = () => {
      state.soundOn = !state.soundOn;
      localStorage.setItem('neon_dodge_sound', state.soundOn ? 'on' : 'off');
      updateSoundBtn();
      if(state.soundOn){
        ensureAudio();
        beep({freq:740,duration:.06,type:'triangle',gain:.03});
        if(state.running && !state.paused) startBgm();
      } else {
        stopBgm();
      }
    };
    if(adShieldBtn) adShieldBtn.onclick = watchSchoolAdForShield;

    addEventListener('resize', updateRankingVisibility);

    if(navGame) navGame.onclick = scrollToGame;
    if(navRank) navRank.onclick = scrollToRank;
    if(navBug) navBug.onclick = scrollToBug;
    if(bugSubmit) bugSubmit.onclick = submitBug;
    if(bugAdminBtn) bugAdminBtn.onclick = openBugAdminPanel;
    if(bugAdminClose) bugAdminClose.onclick = closeBugAdminPanel;
    if(bugList){
      bugList.addEventListener('click', (e) => {
        const btn = e.target.closest('.bug-del');
        if(!btn) return;
        const t = btn.getAttribute('data-token');
        if(t) deleteBug(decodeURIComponent(t));
      });
    }

    addEventListener('scroll', () => {
      const isMobile = window.matchMedia('(max-width: 760px)').matches;
      if(isMobile && mobileNav) mobileNav.classList.remove('hidden');
    }, { passive:true });

    refreshHUD();
    updateSoundBtn();
    setOverlay('NEON DODGE', '좌우 이동으로 장애물을 피하세요', true);
    applyMaintenanceGate();
    loadRanking();
    if (bugAdminKey) {
      if(bugAdminPanel) bugAdminPanel.style.display = 'block';
      if(bugAdminBtn) bugAdminBtn.textContent = '관리자 ON';
      loadBugList();
    }
    setInterval(loadRanking, 5000);
    setInterval(() => {
      if (bugAdminKey && bugAdminPanel && bugAdminPanel.style.display !== 'none') loadBugList();
    }, 5000);
    setInterval(refreshHUD, 500);
    setNav('game');
    loop();
  </script>
</body>
</html>
